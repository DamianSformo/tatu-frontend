<!-- ===== CONTENEDOR PRINCIPAL DE BÚSQUEDA Y FILTROS ===== -->
<div class="search-filter-container-2">
  <div class="search-filter-container">
    
    <!-- ===== BOTÓN DE FILTROS ===== -->
    <div class="filter-button">
      <button (click)="toggleFilters()">
        <lucide-icon name="sliders-horizontal"></lucide-icon>
      </button>
    </div>

    <!-- ===== CAJA DE BÚSQUEDA PRINCIPAL ===== -->
    <div class="search-box">
      
      <!-- Icono de búsqueda -->
      <lucide-icon class="search-icon" name="search"></lucide-icon>
      
      <!-- Input de búsqueda -->
      <input
        type="text"
        [(ngModel)]="query"
        [placeholder]="placeholder"
        (keyup.enter)="onSearch()" 
      />

      <!-- ===== SELECTOR DE CATEGORÍA DESPLEGABLE ===== -->
      <div  *ngIf="!isCategorySelectionDisabled"
        class="category-dropdown" 
        [class.active]="showCategory" 
        (click)="!isCategorySelectionDisabled && toggleCategory()"
        [class.disabled]="isCategorySelectionDisabled"
      >
        {{ initialCategoryName }}
        <lucide-icon name="chevron-down"></lucide-icon>

        <!-- Panel desplegable de categorías -->
        <div class="search-and-panel-wrapper">
          <div class="category-panel" *ngIf="showCategory">
            <div class="position-content">
              
              <!-- Lista de categorías -->
              <div
                class="category-item"
                *ngFor="let c of categories"
                (click)="selectCategory(c); $event.stopPropagation()"
                [class.is-selected]="c.key === selectedCategory.key"
              >
                {{ c.name }}
              </div>
              
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Overlay para filtros -->
<div class="filters-overlay" *ngIf="showFilters" (click)="closeFilters()"></div>
<!-- ===== PANEL DESPLEGABLE DE FILTROS ===== -->
<div class="filters-panel" *ngIf="showFilters">
  <div class="filters-content">
    
    <!-- Título del panel -->
    <h3>Filtros</h3>
    <button class="btn-close-x" (click)="closeFilters()" aria-label="Cerrar">
        <lucide-icon name="x"></lucide-icon>
      </button>

    <!-- ===== GRUPOS DE FILTROS ===== -->
    <div *ngFor="let f of activeFilters" class="filter-group">

      <!-- ===== HEADER DEL FILTRO (ACORDEÓN) ===== -->
      <div class="filter-header" (click)="toggleFilter(f)">
        <span class="filter-title">{{ f.label }}</span>
        <lucide-icon [name]="f.open ? 'chevron-up' : 'chevron-down'"></lucide-icon>
      </div>

      <!-- ===== RESUMEN DE OPCIONES SELECCIONADAS ===== -->
      <div class="filter-summary" *ngIf="!f.open && f.value?.length && f.key !== 'order'">
        {{ f.value.join(', ') }}
      </div>

      <!-- ===== RESUMEN PARA RADIO (MUESTRA LA OPCIÓN SELECCIONADA) ===== -->
      <div class="filter-summary" *ngIf="!f.open && f.value && f.key === 'order'">
        {{ f.value }}
      </div>

      <!-- ===== CONTENIDO DEL FILTRO (SE EXPANDE AL HACER CLICK) ===== -->
      <div class="filter-options" *ngIf="f.open">

        <!-- ===== FILTRO TIPO CHECKBOX (PILLS) ===== -->
        <div *ngIf="f.type === 'checkbox'" class="checkbox-pills">
          <div 
            *ngFor="let opt of getOptionsWithCount(f)" 
            class="pill" 
            [class.selected]="f.value.includes(opt.value)"
            [class.disabled]="opt.count === 0"
            (click)="opt.count !== 0 && toggleOption(f, opt.value)"
          >
            {{ opt.label }}
          </div>
        </div>

        <!-- ===== FILTRO TIPO RADIO (UNA SOLA OPCIÓN) - ESTILO SELECT ===== -->
        <div *ngIf="f.type === 'radio'" class="radio-options">
          <div class="options-dropdown" *ngIf="f.open">
            <div 
              class="option-item" 
              *ngFor="let opt of f.options"
              [class.selected]="f.value === opt"
            >
              <label>
                <input
                  type="radio"
                  [value]="opt"
                  [(ngModel)]="f.value"
                  [name]="f.key"
                />
                
                <span class="text-radio">{{ opt }}</span>
              </label>
            </div>
          </div>
        </div>

        <!-- ===== FILTRO TIPO SELECT CON BÚSQUEDA ===== -->
        <div *ngIf="f.type === 'select-search'" class="select-search">
          <div class="options-dropdown" *ngIf="f.open">
            
            <!-- Input de búsqueda interno -->
            <div class="search-box">
              <lucide-icon class="search-icon" name="search"></lucide-icon>
              <input
                type="text"
                placeholder="Buscar..."
                [(ngModel)]="f.searchTerm"
                class="search-input" 
              />
            </div>

            <!-- Lista filtrada de opciones con "Ver más" -->
            <div 
              class="option-item" 
              *ngFor="let opt of ((f.optionsWithCount ?? []) | filter: (f.searchTerm ?? '')) | slice:0:(f.showAllOptions ? (f.optionsWithCount?.length || 0) : 5)"
              [class.disabled]="opt.count === 0"
            >
              <label class="option-label-flex" [class.disabled]="opt.count === 0">
                <input
                  type="checkbox"
                  [checked]="f.value.includes(opt.value)"
                  [disabled]="opt.count === 0"
                  (change)="toggleOption(f, opt.value)"
                />
                <span class="custom-checkbox"></span>
                <span class="text-checkbox">{{ opt.label }}</span>
                <span class="option-count">{{ opt.count }}</span>
              </label>
            </div>

            <!-- Botón Ver más/menos -->
            <button class="btn-view-more" *ngIf="f.optionsWithCount && f.optionsWithCount.length > 5" (click)="toggleShowAllOptions(f)">
              {{ f.showAllOptions ? 'Ver menos' : 'Ver más' }}
            </button>
            
          </div>
        </div>

        <!-- ===== FILTRO TIPO SELECT SIMPLE (IGUAL AL SELECT-SEARCH PERO SIN LUPA) ===== -->
<div *ngIf="f.type === 'select'" class="select-simple">
  <div class="options-dropdown" *ngIf="f.open">

    <div 
      class="option-item" 
      *ngFor="let opt of (f.optionsWithCount ?? []) | slice:0:(f.showAllOptions ? (f.optionsWithCount?.length || 0) : 5)"
      [class.selected]="f.value.includes(opt.value)"
      [class.disabled]="opt.count === 0"
    >
      <label class="option-label-flex" [class.disabled]="opt.count === 0">
        <input
          type="checkbox"
          [checked]="f.value.includes(opt.value)"
          [disabled]="opt.count === 0"
          (change)="toggleOption(f, opt.value)"
        />
        <span class="custom-checkbox"></span>
        <span class="text-checkbox">{{ opt.label }}</span>
        <span class="option-count">{{ opt.count }}</span>
      </label>
    </div>

    <!-- Botón Ver más/menos -->
    <button class="btn-view-more" *ngIf="f.optionsWithCount && f.optionsWithCount.length > 5" (click)="toggleShowAllOptions(f)">
      {{ f.showAllOptions ? 'Ver menos' : 'Ver más' }}
    </button>

  </div>
</div>

        <!-- ===== FILTRO DE RANGO DE PRECIO COMPLETO ===== -->
        <div *ngIf="f.type === 'price-range'" class="range-filter">

          <!-- Histograma de precios -->
          <div class="price-histogram">
            <div 
              *ngFor="let h of f.bars"
              class="bar"
              [style.height.%]="h"
            ></div>
          </div>

          <!-- Slider doble para rango de precios -->
          <div class="double-slider">
            
            <!-- Control deslizante para precio mínimo -->
            <input 
              class="inputote"
              type="range"
              [min]="f.min"
              [max]="f.max"
              [ngModel]="f.value[0]"
              (input)="updatePrice(f, 0, $any($event.target).value)"
            />

            <!-- Control deslizante para precio máximo -->
            <input 
              class="inputito"
              type="range"
              [min]="f.min"
              [max]="f.max"
              [ngModel]="f.value[1]"
              (input)="updatePrice(f, 1, $any($event.target).value)"
            />
            
          </div>

          <!-- Inputs de precio en formato pill -->
          <div class="price-inputs">
            <div class="price-pill">
              <label>Mínimo</label>
              <div class="pill-box">${{ f.value[0] }}</div>
            </div>
            <div class="price-pill">
              <label>Máximo</label>
              <div class="pill-box">${{ f.value[1] }}</div>
            </div>
          </div>
          
        </div>
        
      </div>
    </div>

    <!-- ===== BOTONES DE ACCIÓN DEL PANEL ===== -->
    <div class="filters-actions-custom">
      <!-- Botón Cerrar (cruz) arriba derecha -->
      

      <!-- Botón Borrar abajo izquierda -->
      <button class="btn-clear-custom" (click)="clearFilters()">Borrar</button>

      <!-- Botón Aplicar abajo derecha -->
      <button class="btn-apply-custom" (click)="applyFilterChanges()">
        Mostrar {{ filteredProductsCount }} producto{{ filteredProductsCount === 1 ? '' : 's' }}
      </button>
    </div>
  </div>
</div>